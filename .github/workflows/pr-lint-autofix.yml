name: PRè‡ªå‹•ä¿®æ­£ï¼ˆCopiloté€£æºï¼‰

on:
    # Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†æ™‚ã®ã¿ãƒˆãƒªã‚¬ãƒ¼
    pull_request_review:
        types: [submitted]

permissions:
    contents: read
    pull-requests: read

jobs:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ã‚¸ãƒ§ãƒ–1: å‰æº–å‚™ï¼ˆCopilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿ã‚’å¯¾è±¡ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    prepare:
        runs-on: ubuntu-latest
        # Copilotä»¥å¤–ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆdownstream jobã‚‚é€£é–ã—ã¦ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ï¼‰
        if: contains(github.event.review.user.login, 'copilot')
        steps:
            - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.ref }}

            - name: Node.js 24ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            # npm ciã‚’å®Ÿè¡Œã—ã¦npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆã—ã€å¾Œç¶šã‚¸ãƒ§ãƒ–ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é«˜é€ŸåŒ–ã™ã‚‹
            - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: npm ci

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ã‚¸ãƒ§ãƒ–2: ESLinté™çš„è§£æï¼ˆprepareã¨ä¸¦åˆ—ã§knipã¨åŒæ™‚å®Ÿè¡Œï¼‰
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    lint:
        runs-on: ubuntu-latest
        needs: [prepare]
        steps:
            - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.ref }}

            - name: Node.js 24ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: npm ci

            # ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ãŸã‚continue-on-error: trueã‚’è¨­å®š
            - name: ESLintã‚’å®Ÿè¡Œï¼ˆJSONå‡ºåŠ›ï¼‰
              continue-on-error: true
              run: npm run lint

            # autofixã‚¸ãƒ§ãƒ–ã§å‚ç…§ã™ã‚‹ãŸã‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
            - name: ESLintçµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
              uses: actions/upload-artifact@v4
              with:
                  name: eslint-results
                  path: eslint_results.json
                  if-no-files-found: warn

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ã‚¸ãƒ§ãƒ–3: knipæœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰è§£æï¼ˆlintã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    knip:
        runs-on: ubuntu-latest
        needs: [prepare]
        steps:
            - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.ref }}

            - name: Node.js 24ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: npm ci

            # æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¦ã‚‚å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ãŸã‚continue-on-error: trueã‚’è¨­å®š
            - name: knipã‚’å®Ÿè¡Œï¼ˆJSONå‡ºåŠ›ï¼‰
              continue-on-error: true
              run: npm run knip

            # autofixã‚¸ãƒ§ãƒ–ã§å‚ç…§ã™ã‚‹ãŸã‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
            - name: knipçµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
              uses: actions/upload-artifact@v4
              with:
                  name: knip-results
                  path: knip_results.json
                  if-no-files-found: warn

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ã‚¸ãƒ§ãƒ–4: Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾— â†’ è‡ªå‹•ä¿®æ­£ â†’ PRè§£æ±ºæ¸ˆã¿æ›´æ–°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    autofix:
        runs-on: ubuntu-latest
        needs: [lint, knip]
        steps:
            # pushã§ãã‚‹ã‚ˆã†fetch-depth: 0ã§ãƒ•ãƒ«ã‚¯ãƒ­ãƒ¼ãƒ³
            - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  fetch-depth: 0

            - name: Node.js 24ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: npm ci

            # lint/knipã‚¸ãƒ§ãƒ–ã§ç”Ÿæˆã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
            - name: ESLintçµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              uses: actions/download-artifact@v4
              with:
                  name: eslint-results
              continue-on-error: true

            - name: knipçµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              uses: actions/download-artifact@v4
              with:
                  name: knip-results
              continue-on-error: true

            # Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡ã¨ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’GH APIã§å–å¾—ã—ã¦1ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹
            - name: Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  {
                    echo "## GitHub Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡"
                    echo "${{ github.event.review.body }}"
                    echo ""
                    echo "## GitHub Copilot ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ"
                    gh api \
                      repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
                      --jq '.[] | select(.user.login | ascii_downcase | contains("copilot")) |
                            "ãƒ•ã‚¡ã‚¤ãƒ«: \(.path) è¡Œ\(.line // .original_line): \(.body)"'
                  } > /tmp/copilot_review.txt

            # CLAUDE.mdãƒ»Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ESLintãƒ»knipã®çµæœã‚’çµ±åˆã—ãŸä¿®æ­£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹
            - name: è‡ªå‹•ä¿®æ­£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
              run: |
                  {
                    echo "ã‚ãªãŸã¯TypeScript/AWS CDKã®å°‚é–€å®¶ã§ã™ã€‚"
                    echo "ä»¥ä¸‹ã®é–‹ç™ºè¦ç´„ï¼ˆCLAUDE.mdï¼‰ã«å¾“ã„ã€ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»é™çš„è§£æã®çµæœã®ã†ã¡"
                    echo "ã€Œå¯¾å¿œãŒå¿…è¦ã€ã¨åˆ¤æ–­ã—ãŸã‚‚ã®ã ã‘ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
                    echo ""
                    echo "## ä¿®æ­£ã®åˆ¤æ–­åŸºæº–ï¼ˆå¿…ãšå®ˆã‚‹ã“ã¨ï¼‰"
                    echo "- ESLintã®ã‚¨ãƒ©ãƒ¼ï¼ˆseverity=2ï¼‰ã¯å¿…ãšä¿®æ­£ã™ã‚‹"
                    echo "- ESLintã®è­¦å‘Šï¼ˆseverity=1ï¼‰ã¯ã€CLAUDE.mdã®è¦ç´„ã«æ˜ç¢ºã«é•åã—ã¦ã„ã‚‹å ´åˆã®ã¿ä¿®æ­£ã™ã‚‹"
                    echo "- knipã®æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã¯ã€DRYåŸå‰‡ãƒ»å˜ä¸€è²¬ä»»ã®åŸå‰‡ã«é•åã—ã¦ã„ã‚‹å ´åˆã®ã¿ä¿®æ­£ã™ã‚‹"
                    echo "- Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€é–‹ç™ºè¦ç´„ã«é•åã—ã¦ã„ã‚‹æŒ‡æ‘˜ã®ã¿ä¿®æ­£ã™ã‚‹"
                    echo "- å‹•ä½œã«å½±éŸ¿ã—ãªã„è»½å¾®ãªå•é¡Œãƒ»å¥½ã¿ã®å•é¡Œã¯ä¿®æ­£ã—ãªã„"
                    echo "- AWS CDKã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®æ§‹é€ ãƒ»å‹•ä½œã¯å¤‰ãˆãªã„"
                    echo ""
                    echo "## é–‹ç™ºè¦ç´„ï¼ˆCLAUDE.mdï¼‰"
                    cat CLAUDE.md
                    echo ""
                    echo "## GitHub Copilot ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ"
                    cat /tmp/copilot_review.txt 2>/dev/null || echo "ï¼ˆCopilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãªã—ï¼‰"
                    echo ""
                    echo "## ESLinté™çš„è§£æçµæœï¼ˆJSONï¼‰"
                    cat eslint_results.json 2>/dev/null || echo "ï¼ˆESLintçµæœãªã—ï¼‰"
                    echo ""
                    echo "## knipæœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰è§£æçµæœï¼ˆJSONï¼‰"
                    cat knip_results.json 2>/dev/null || echo "ï¼ˆknipçµæœãªã—ï¼‰"
                  } > /tmp/fix-prompt.txt

            - name: OpenAI Codexï¼ˆgpt-5ï¼‰ã§ã‚³ãƒ¼ãƒ‰è‡ªå‹•ä¿®æ­£
              uses: openai/codex-action@v1
              with:
                  openai-api-key: ${{ secrets.OPENAI_API_KEY }}
                  model: gpt-5
                  prompt-file: /tmp/fix-prompt.txt
                  safety-strategy: drop-sudo
                  output-file: /tmp/codex-output.txt

            # å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆãƒ»pushï¼ˆ[skip ci]ã§ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å†ãƒˆãƒªã‚¬ãƒ¼ã‚’é˜²æ­¢ï¼‰
            - name: ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦push
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add -A
                  if git diff --cached --quiet; then
                    echo "ä¿®æ­£å¯¾è±¡ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
                  else
                    git commit -m "fix: Copilot/ESLint/knipã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ [skip ci]"
                    git push origin HEAD
                  fi

            # å„Copilotã‚¹ãƒ¬ãƒƒãƒ‰ã«è§£æ±ºç†ç”±ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿”ä¿¡ã—ã¦ã‹ã‚‰è§£æ±ºæ¸ˆã¿ã«æ›´æ–°ã™ã‚‹
            - name: Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã«è§£æ±ºç†ç”±ã‚’è¿”ä¿¡ã—ã¦è§£æ±ºæ¸ˆã¿ã«æ›´æ–°
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # ä¿®æ­£å†…å®¹ã‚µãƒãƒªãƒ¼ã‚’èª­ã¿è¾¼ã‚€ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼‰
                  CODEX_SUMMARY=$(cat /tmp/codex-output.txt 2>/dev/null | head -c 1000 || echo "è‡ªå‹•ä¿®æ­£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚Šå¯¾å¿œã—ã¾ã—ãŸã€‚")
                  COMMIT_SHA=$(git rev-parse --short HEAD 2>/dev/null || echo "ï¼ˆã‚³ãƒŸãƒƒãƒˆãªã—ï¼‰")

                  # è§£æ±ºç†ç”±ã®ã‚³ãƒ¡ãƒ³ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
                  RESOLVE_COMMENT="ğŸ¤– **è‡ªå‹•ä¿®æ­£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚‹å¯¾å¿œ**

                  ã“ã®æŒ‡æ‘˜ã¯OpenAI Codexï¼ˆgpt-5ï¼‰ã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ã§å¯¾å¿œã—ã¾ã—ãŸã€‚

                  **ä¿®æ­£å†…å®¹ã®ã‚µãƒãƒªãƒ¼:**
                  ${CODEX_SUMMARY}

                  **å¯¾å¿œã‚³ãƒŸãƒƒãƒˆ:** ${COMMIT_SHA}

                  *CLAUDE.mdã®é–‹ç™ºè¦ç´„ã«åŸºã¥ãã€å¯¾å¿œãŒå¿…è¦ã¨åˆ¤æ–­ã•ã‚ŒãŸæŒ‡æ‘˜ã®ã¿ã‚’ä¿®æ­£ã—ã¦ã„ã¾ã™ã€‚*"

                  # æœªè§£æ±ºã®Copilotã‚¹ãƒ¬ãƒƒãƒ‰IDã¨ã‚³ãƒ¡ãƒ³ãƒˆIDã‚’GraphQL APIã§å–å¾—
                  gh api graphql -f query='
                    query($owner: String!, $repo: String!, $prNumber: Int!) {
                      repository(owner: $owner, name: $repo) {
                        pullRequest(number: $prNumber) {
                          reviewThreads(first: 100) {
                            nodes {
                              id
                              isResolved
                              comments(first: 1) {
                                nodes {
                                  databaseId
                                  author { login }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  ' \
                    -f owner=${{ github.repository_owner }} \
                    -f repo=${{ github.event.repository.name }} \
                    -F prNumber=${{ github.event.pull_request.number }} \
                    --jq '
                      .data.repository.pullRequest.reviewThreads.nodes[]
                      | select(
                          .isResolved == false and
                          (.comments.nodes[0].author.login | ascii_downcase | contains("copilot"))
                        )
                      | "\(.id) \(.comments.nodes[0].databaseId)"
                    ' > /tmp/thread_info.txt

                  while IFS=' ' read -r thread_id comment_db_id; do
                    # è§£æ±ºç†ç”±ã‚’ã‚¹ãƒ¬ãƒƒãƒ‰ã«è¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
                    gh api graphql -f query='
                      mutation($threadId: ID!, $body: String!) {
                        addPullRequestReviewThreadReply(input: {
                          pullRequestReviewThreadId: $threadId,
                          body: $body
                        }) {
                          comment { id }
                        }
                      }
                    ' -f threadId="$thread_id" -f body="$RESOLVE_COMMENT"
                    echo "è¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿: $thread_id"

                    # ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’è§£æ±ºæ¸ˆã¿ã«æ›´æ–°
                    gh api graphql -f query='
                      mutation($threadId: ID!) {
                        resolveReviewThread(input: { threadId: $threadId }) {
                          thread { isResolved }
                        }
                      }
                    ' -f threadId="$thread_id"
                    echo "è§£æ±ºæ¸ˆã¿ã«æ›´æ–°: $thread_id"
                  done < /tmp/thread_info.txt
