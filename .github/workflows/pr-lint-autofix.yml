name: PRè‡ªå‹•ä¿®æ­£ï¼ˆCopiloté€£æºï¼‰

on:
    # PRã«ã€Œ@fixã€ã¨ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
    # issue_commentã®actorã¯ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸäººé–“ï¼ˆwriteæ¨©é™ã‚ã‚Šï¼‰ã«ãªã‚‹ãŸã‚
    # codex-actionã®collaboratorãƒã‚§ãƒƒã‚¯ã‚’ç¢ºå®Ÿã«é€šéã§ãã‚‹
    issue_comment:
        types: [created]

permissions:
    contents: write
    pull-requests: write

jobs:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ã‚¸ãƒ§ãƒ–1: å‰æº–å‚™
    # PRã¸ã®ã€Œ@fixã€ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã‚’å¯¾è±¡ã¨ã—ã€head_refã‚’APIã§å–å¾—ã—ã¦å¾Œç¶šã‚¸ãƒ§ãƒ–ã«æ¸¡ã™
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    prepare:
        runs-on: ubuntu-latest
        # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã¤ã€Œ@fixã€ã‚’å«ã‚€å ´åˆã®ã¿å®Ÿè¡Œã™ã‚‹
        if: |
            github.event.issue.pull_request != null &&
            contains(github.event.comment.body, '@fix')
        outputs:
            head_ref: ${{ steps.pr-info.outputs.head_ref }}
            pr_number: ${{ steps.pr-info.outputs.pr_number }}
        steps:
            # issue_commentã‚¤ãƒ™ãƒ³ãƒˆã«ã¯head.refãŒå«ã¾ã‚Œãªã„ãŸã‚APIã§å–å¾—ã™ã‚‹
            - name: PRã®ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’å–å¾—
              id: pr-info
              uses: actions/github-script@v7
              with:
                  script: |
                      const prNumber = context.issue.number;
                      const { data: pr } = await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: prNumber,
                      });
                      core.setOutput('pr_number', String(prNumber));
                      core.setOutput('head_ref', pr.head.ref);

            - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ steps.pr-info.outputs.head_ref }}

            - name: Node.js 24ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            # npm ciã‚’å®Ÿè¡Œã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆã—å¾Œç¶šã‚¸ãƒ§ãƒ–ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é«˜é€ŸåŒ–ã™ã‚‹
            - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: npm ci

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ã‚¸ãƒ§ãƒ–2: ESLinté™çš„è§£æï¼ˆprepareã®å¾Œã€knipã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    lint:
        runs-on: ubuntu-latest
        needs: [prepare]
        steps:
            - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.prepare.outputs.head_ref }}

            - name: Node.js 24ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: npm ci

            # ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ãŸã‚continue-on-error: trueã‚’è¨­å®š
            - name: ESLintã‚’å®Ÿè¡Œï¼ˆJSONå‡ºåŠ›ï¼‰
              continue-on-error: true
              run: npm run lint

            # autofixã‚¸ãƒ§ãƒ–ã§å‚ç…§ã™ã‚‹ãŸã‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
            - name: ESLintçµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
              uses: actions/upload-artifact@v4
              with:
                  name: eslint-results
                  path: eslint_results.json
                  if-no-files-found: warn

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ã‚¸ãƒ§ãƒ–3: knipæœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰è§£æï¼ˆlintã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    knip:
        runs-on: ubuntu-latest
        needs: [prepare]
        steps:
            - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.prepare.outputs.head_ref }}

            - name: Node.js 24ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: npm ci

            # æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¦ã‚‚å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ãŸã‚continue-on-error: trueã‚’è¨­å®š
            - name: knipã‚’å®Ÿè¡Œï¼ˆJSONå‡ºåŠ›ï¼‰
              continue-on-error: true
              run: npm run knip

            # autofixã‚¸ãƒ§ãƒ–ã§å‚ç…§ã™ã‚‹ãŸã‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
            - name: knipçµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
              uses: actions/upload-artifact@v4
              with:
                  name: knip-results
                  path: knip_results.json
                  if-no-files-found: warn

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ã‚¸ãƒ§ãƒ–4: Jestãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬ï¼ˆlintã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    test:
        runs-on: ubuntu-latest
        needs: [prepare]
        steps:
            - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.prepare.outputs.head_ref }}

            - name: Node.js 24ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: npm ci

            # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã‚‚å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ãŸã‚continue-on-error: trueã‚’è¨­å®š
            - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆJSONå‡ºåŠ›ãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬ï¼‰
              continue-on-error: true
              run: npx jest --json --outputFile=jest_results.json --coverage --coverageReporters=json-summary

            # autofixã‚¸ãƒ§ãƒ–ã§å‚ç…§ã™ã‚‹ãŸã‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
            - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
              uses: actions/upload-artifact@v4
              with:
                  name: test-results
                  path: |
                      jest_results.json
                      coverage/coverage-summary.json
                  if-no-files-found: warn

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ã‚¸ãƒ§ãƒ–5: Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾— â†’ è‡ªå‹•ä¿®æ­£ â†’ PRè§£æ±ºæ¸ˆã¿æ›´æ–°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    autofix:
        runs-on: ubuntu-latest
        needs: [prepare, lint, knip, test]
        steps:
            # pushã§ãã‚‹ã‚ˆã†fetch-depth: 0ã§ãƒ•ãƒ«ã‚¯ãƒ­ãƒ¼ãƒ³
            - name: PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.prepare.outputs.head_ref }}
                  fetch-depth: 0

            - name: Node.js 24ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: npm ci

            # lint/knipã‚¸ãƒ§ãƒ–ã§ç”Ÿæˆã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
            - name: ESLintçµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              uses: actions/download-artifact@v4
              with:
                  name: eslint-results
              continue-on-error: true

            - name: knipçµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              uses: actions/download-artifact@v4
              with:
                  name: knip-results
              continue-on-error: true

            - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              uses: actions/download-artifact@v4
              with:
                  name: test-results
              continue-on-error: true

            # Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’APIã§å–å¾—ã™ã‚‹ï¼ˆissue_commentã‚¤ãƒ™ãƒ³ãƒˆã«ã¯reviewæƒ…å ±ãŒãªã„ãŸã‚ï¼‰
            # REST APIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡ãƒ»ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã—ã€GraphQL APIã§ã‚¹ãƒ¬ãƒƒãƒ‰è©³ç´°ã‚‚å–å¾—ã™ã‚‹
            - name: Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const prNumber = parseInt('${{ needs.prepare.outputs.pr_number }}');

                      // ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡ï¼ˆRESTï¼‰
                      const { data: reviews } = await github.rest.pulls.listReviews({
                        owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber,
                      });
                      const copilotReview = reviews
                        .filter(r => r.user.login.toLowerCase().includes('copilot'))
                        .at(-1);

                      // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆRESTï¼‰
                      const { data: comments } = await github.rest.pulls.listReviewComments({
                        owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber,
                      });
                      const copilotComments = comments.filter(c =>
                        c.user.login.toLowerCase().includes('copilot')
                      );

                      // codexç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
                      let reviewText = '## GitHub Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡\n';
                      reviewText += (copilotReview?.body ?? '') + '\n\n';
                      reviewText += '## GitHub Copilot ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ\n';
                      for (const c of copilotComments) {
                        reviewText += `ãƒ•ã‚¡ã‚¤ãƒ«: ${c.path} è¡Œ${c.line ?? c.original_line}: ${c.body}\n`;
                      }
                      fs.writeFileSync('/tmp/copilot_review.txt', reviewText);

                      // ã‚¹ãƒ¬ãƒƒãƒ‰è©³ç´°JSONï¼ˆGraphQLï¼‰ï¼šå¾Œç¶šã®å€‹åˆ¥åˆ†æã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨
                      const result = await github.graphql(`
                        query($owner: String!, $repo: String!, $prNumber: Int!) {
                          repository(owner: $owner, name: $repo) {
                            pullRequest(number: $prNumber) {
                              reviewThreads(first: 100) {
                                nodes {
                                  id isResolved path line originalLine
                                  comments(first: 1) {
                                    nodes { author { login } body }
                                  }
                                }
                              }
                            }
                          }
                        }
                      `, { owner: context.repo.owner, repo: context.repo.repo, prNumber });

                      const threads = result.repository.pullRequest.reviewThreads.nodes
                        .filter(n =>
                          !n.isResolved &&
                          n.comments.nodes[0]?.author?.login?.toLowerCase().includes('copilot')
                        )
                        .map(n => ({
                          id: n.id,
                          path: n.path,
                          line: n.line ?? n.originalLine,
                          body: n.comments.nodes[0].body,
                        }));

                      fs.writeFileSync('/tmp/copilot_threads.json', JSON.stringify(threads));
                      console.log(`å–å¾—ã—ãŸCopilotã‚¹ãƒ¬ãƒƒãƒ‰æ•°: ${threads.length}`);

            # copilot-instructions.mdãƒ»Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ESLintãƒ»knipã®çµæœã‚’çµ±åˆã—ãŸä¿®æ­£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹
            - name: è‡ªå‹•ä¿®æ­£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
              run: |
                  {
                    echo "ã‚ãªãŸã¯TypeScript/AWS CDKã®å°‚é–€å®¶ã§ã™ã€‚"
                    echo "ä»¥ä¸‹ã®é–‹ç™ºè¦ç´„ï¼ˆcopilot-instructions.mdï¼‰ã«å¾“ã„ã€ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»é™çš„è§£æã®çµæœã®ã†ã¡"
                    echo "ã€Œå¯¾å¿œãŒå¿…è¦ã€ã¨åˆ¤æ–­ã—ãŸã‚‚ã®ã ã‘ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
                    echo ""
                    echo "## ä¿®æ­£ã®åˆ¤æ–­åŸºæº–ï¼ˆå¿…ãšå®ˆã‚‹ã“ã¨ï¼‰"
                    echo "- ESLintã®ã‚¨ãƒ©ãƒ¼ï¼ˆseverity=2ï¼‰ã¯å¿…ãšä¿®æ­£ã™ã‚‹"
                    echo "- ESLintã®è­¦å‘Šï¼ˆseverity=1ï¼‰ã¯ã€copilot-instructions.mdã®è¦ç´„ã«æ˜ç¢ºã«é•åã—ã¦ã„ã‚‹å ´åˆã®ã¿ä¿®æ­£ã™ã‚‹"
                    echo "- knipã®æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã¯ã€DRYåŸå‰‡ãƒ»å˜ä¸€è²¬ä»»ã®åŸå‰‡ã«é•åã—ã¦ã„ã‚‹å ´åˆã®ã¿ä¿®æ­£ã™ã‚‹"
                    echo "- Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€é–‹ç™ºè¦ç´„ã«é•åã—ã¦ã„ã‚‹æŒ‡æ‘˜ã®ã¿ä¿®æ­£ã™ã‚‹"
                    echo "- ãƒ†ã‚¹ãƒˆãŒ1ä»¶ã§ã‚‚å¤±æ•—ã—ã¦ã„ã‚‹å ´åˆã¯å¿…ãšä¿®æ­£ã—ã¦å…¨ä»¶æˆåŠŸã•ã›ã‚‹ã“ã¨"
                    echo "- linesã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ65%æœªæº€ã®å ´åˆã¯ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ãƒ»ä¿®æ­£ã—ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ”¹å–„ã™ã‚‹ã“ã¨"
                    echo "- å‹•ä½œã«å½±éŸ¿ã—ãªã„è»½å¾®ãªå•é¡Œãƒ»å¥½ã¿ã®å•é¡Œã¯ä¿®æ­£ã—ãªã„"
                    echo "- AWS CDKã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®æ§‹é€ ãƒ»å‹•ä½œã¯å¤‰ãˆãªã„"
                    echo ""
                    echo "## é–‹ç™ºè¦ç´„(copilot-instructions.md)"
                    cat .github/copilot-instructions.md
                    echo ""
                    echo "## GitHub Copilot ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ"
                    cat /tmp/copilot_review.txt 2>/dev/null || echo "ï¼ˆCopilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãªã—ï¼‰"
                    echo ""
                    echo "## ESLinté™çš„è§£æçµæœï¼ˆJSONï¼‰"
                    cat eslint_results.json 2>/dev/null || echo "ï¼ˆESLintçµæœãªã—ï¼‰"
                    echo ""
                    echo "## knipæœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰è§£æçµæœï¼ˆJSONï¼‰"
                    cat knip_results.json 2>/dev/null || echo "ï¼ˆknipçµæœãªã—ï¼‰"
                    echo ""
                    echo "## Jestãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœï¼ˆJSONï¼‰"
                    cat jest_results.json 2>/dev/null || echo "ï¼ˆãƒ†ã‚¹ãƒˆçµæœãªã—ï¼‰"
                    echo ""
                    echo "## Jestã‚«ãƒãƒ¬ãƒƒã‚¸çµæœï¼ˆJSONï¼‰"
                    cat coverage/coverage-summary.json 2>/dev/null || echo "ï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸çµæœãªã—ï¼‰"
                  } > /tmp/fix-prompt.txt

            # actorã¯ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸäººé–“ï¼ˆwriteæ¨©é™ã‚ã‚Šï¼‰ã®ãŸã‚collaboratorãƒã‚§ãƒƒã‚¯ã‚’é€šéã™ã‚‹
            - name: OpenAI Codexï¼ˆgpt-5ï¼‰ã§ã‚³ãƒ¼ãƒ‰è‡ªå‹•ä¿®æ­£
              uses: openai/codex-action@v1
              with:
                  openai-api-key: ${{ secrets.OPENAI_API_KEY }}
                  model: gpt-5
                  prompt-file: /tmp/fix-prompt.txt
                  safety-strategy: drop-sudo
                  output-file: /tmp/codex-output.txt

            # å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆãƒ»pushï¼ˆ[skip ci]ã§ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å†ãƒˆãƒªã‚¬ãƒ¼ã‚’é˜²æ­¢ï¼‰
            # SHAã‚’å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹ãŸã‚outputã¨ã—ã¦å‡ºåŠ›ã™ã‚‹
            - name: ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦push
              id: commit-push
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add -A
                  if git diff --cached --quiet; then
                    echo "ä¿®æ­£å¯¾è±¡ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
                    echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
                  else
                    git commit -m "fix: Copilot/ESLint/knipã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ [skip ci]"
                    git push origin HEAD
                    echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
                  fi

            # git diffãƒ»codexã‚µãƒãƒªãƒ¼ãƒ»é–‹ç™ºè¦ç´„ãƒ»Copilotã‚³ãƒ¡ãƒ³ãƒˆã‚’ææ–™ã«gpt-4oã§å¯¾å¿œçŠ¶æ³ã‚’åˆ†æã™ã‚‹
            - name: å„Copilotã‚³ãƒ¡ãƒ³ãƒˆã¸ã®å¯¾å¿œçŠ¶æ³ã‚’AIã§åˆ†æ
              env:
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
              run: |
                  THREADS=$(cat /tmp/copilot_threads.json 2>/dev/null || echo "[]")

                  # ã‚¹ãƒ¬ãƒƒãƒ‰ãŒ0ä»¶ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                  if [ "$(echo "$THREADS" | jq 'length')" -eq 0 ]; then
                    echo "{}" > /tmp/comment_resolutions.json
                    exit 0
                  fi

                  # å„åˆ†æææ–™ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºæ–‡å­—ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                  GIT_DIFF=$(git diff HEAD~1 HEAD 2>/dev/null || echo "")
                  CODEX_OUTPUT=$(cat /tmp/codex-output.txt 2>/dev/null || echo "")
                  DEV_RULES=$(cat .github/copilot-instructions.md 2>/dev/null || echo "")

                  # jqã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’çµ„ã¿ç«‹ã¦ã‚‹ï¼ˆã‚·ã‚§ãƒ«å¤‰æ•°ã®ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
                  jq -n \
                    --arg diff "$GIT_DIFF" \
                    --arg codex_output "$CODEX_OUTPUT" \
                    --arg dev_rules "$DEV_RULES" \
                    --argjson threads "$THREADS" \
                    '{
                      model: "gpt-4o",
                      response_format: {type: "json_object"},
                      messages: [{
                        role: "user",
                        content: (
                          "ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åˆ¤å®šã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚\n"
                          + "ä»¥ä¸‹ã®æƒ…å ±ã‚’ç·åˆçš„ã«å‚ç…§ã—ã€å„Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒAIè‡ªå‹•ä¿®æ­£ã§å¯¾å¿œã•ã‚ŒãŸã‹ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚\n\n"
                          + "## åˆ¤å®šãƒ«ãƒ¼ãƒ«\n"
                          + "- addressed: true â†’ é–‹ç™ºè¦ç´„ã«ç…§ã‚‰ã—ã¦å¯¾å¿œãŒå¿…è¦ã¨åˆ¤æ–­ã•ã‚Œã€git diffã«å¯¾å¿œå¤‰æ›´ãŒç¢ºèªã§ãã‚‹\n"
                          + "- addressed: false â†’ é–‹ç™ºè¦ç´„ã«ç…§ã‚‰ã—ã¦å¯¾å¿œä¸è¦ã¨åˆ¤æ–­ã•ã‚ŒãŸï¼ˆå‹•ä½œã«å½±éŸ¿ã—ãªã„ãƒ»å¥½ã¿ã®å•é¡Œãƒ»è¦ç´„é•åã§ãªã„ç­‰ï¼‰\n"
                          + "- reason ã«ã¯ã€Œé–‹ç™ºè¦ç´„ã®â—‹â—‹ã«åŸºã¥ãã€œã€ã®ã‚ˆã†ã«è¦ç´„ã®è¦³ç‚¹ã‚’å¿…ãšæ˜è¨˜ã™ã‚‹ã“ã¨\n"
                          + "- ã€Œå·®åˆ†ãŒãªã„ã€ã€Œå¤‰æ›´ãŒãªã‹ã£ãŸã€ã ã‘ã®ç†ç”±ã¯ä¸å¯ã€‚å¿…ãšè¦ç´„è¦³ç‚¹ã®èª¬æ˜ã‚’å«ã‚ã‚‹ã“ã¨\n\n"
                          + "## å‡ºåŠ›å½¢å¼ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãªã—ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰\n"
                          + "{\"<ã‚¹ãƒ¬ãƒƒãƒ‰ID>\": {\"addressed\": true/false, \"reason\": \"ç†ç”±\"}, ...}\n\n"
                          + "## é–‹ç™ºè¦ç´„ï¼ˆcopilot-instructions.mdï¼‰\n" + $dev_rules + "\n\n"
                          + "## AIã«ã‚ˆã‚‹ä¿®æ­£ã‚µãƒãƒªãƒ¼ï¼ˆcodex-outputï¼‰\n" + $codex_output + "\n\n"
                          + "## Git Diff\n" + $diff + "\n\n"
                          + "## Copilotã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ï¼ˆJSONï¼‰\n" + ($threads | tostring)
                        )
                      }]
                    }' > /tmp/analysis-request.json

                  # OpenAI APIã‚’å‘¼ã³å‡ºã—ã€JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¿å­˜
                  curl -s https://api.openai.com/v1/chat/completions \
                    -H "Content-Type: application/json" \
                    -H "Authorization: Bearer $OPENAI_API_KEY" \
                    -d @/tmp/analysis-request.json \
                    | jq '.choices[0].message.content | fromjson' > /tmp/comment_resolutions.json

            # å„Copilotã‚¹ãƒ¬ãƒƒãƒ‰ã«AIåˆ†æçµæœã‚’å…ƒã«å€‹åˆ¥è¿”ä¿¡ã—ã€å¯¾å¿œæ¸ˆã¿ã®ã¿è§£æ±ºæ¸ˆã¿ã«æ›´æ–°ã™ã‚‹
            - name: Copilotã‚³ãƒ¡ãƒ³ãƒˆã«å€‹åˆ¥è¿”ä¿¡ã—ã¦é¸æŠçš„ã«è§£æ±ºæ¸ˆã¿æ›´æ–°
              uses: actions/github-script@v7
              env:
                  COMMIT_SHA: ${{ steps.commit-push.outputs.sha }}
              with:
                  script: |
                      const fs = require('fs');

                      const threads = JSON.parse(fs.readFileSync('/tmp/copilot_threads.json', 'utf8'));
                      const resolutions = JSON.parse(
                        fs.readFileSync('/tmp/comment_resolutions.json', 'utf8')
                      );
                      const commitSha = process.env.COMMIT_SHA ?? 'ï¼ˆã‚³ãƒŸãƒƒãƒˆãªã—ï¼‰';

                      for (const thread of threads) {
                        const res = resolutions[thread.id] ?? {
                          addressed: false, reason: 'åˆ†æçµæœãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ',
                        };

                        const comment = res.addressed
                          ? `ğŸ¤– **è‡ªå‹•ä¿®æ­£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚‹å¯¾å¿œï¼ˆå¯¾å¿œæ¸ˆã¿ï¼‰**\n\n` +
                            `ã“ã®æŒ‡æ‘˜ã¯OpenAI Codexï¼ˆgpt-5ï¼‰ã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ã§å¯¾å¿œã—ã¾ã—ãŸã€‚\n\n` +
                            `**å¯¾å¿œå†…å®¹:** ${res.reason}\n\n` +
                            `**å¯¾å¿œã‚³ãƒŸãƒƒãƒˆ:** ${commitSha}`
                          : `ğŸ¤– **è‡ªå‹•ä¿®æ­£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚‹ç¢ºèªï¼ˆæœªå¯¾å¿œï¼‰**\n\n` +
                            `ã“ã®æŒ‡æ‘˜ã¯ä»Šå›ã®è‡ªå‹•ä¿®æ­£ã§ã¯å¯¾å¿œã—ã¾ã›ã‚“ã§ã—ãŸã€‚\n\n` +
                            `**ç†ç”±:** ${res.reason}\n\n` +
                            `*copilot-instructions.mdã®é–‹ç™ºè¦ç´„ã«åŸºã¥ãã€å¯¾å¿œä¸è¦ã¨åˆ¤æ–­ã—ãŸæŒ‡æ‘˜ã¯ä¿®æ­£ã—ã¦ã„ã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚*`;

                        await github.graphql(`
                          mutation($threadId: ID!, $body: String!) {
                            addPullRequestReviewThreadReply(input: {
                              pullRequestReviewThreadId: $threadId, body: $body
                            }) { comment { id } }
                          }
                        `, { threadId: thread.id, body: comment });

                        if (res.addressed) {
                          await github.graphql(`
                            mutation($threadId: ID!) {
                              resolveReviewThread(input: { threadId: $threadId }) { thread { isResolved } }
                            }
                          `, { threadId: thread.id });
                          console.log(`å¯¾å¿œæ¸ˆã¿ãƒ»è§£æ±ºæ¸ˆã¿ã«æ›´æ–°: ${thread.id}`);
                        } else {
                          console.log(`æœªå¯¾å¿œãƒ»resolveã—ãªã„: ${thread.id}`);
                        }
                      }
