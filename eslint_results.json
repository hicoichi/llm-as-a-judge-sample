[{"filePath":"/home/runner/work/llm-as-a-judge-sample/llm-as-a-judge-sample/bin/llm-as-a-judge-sample.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/runner/work/llm-as-a-judge-sample/llm-as-a-judge-sample/eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/runner/work/llm-as-a-judge-sample/llm-as-a-judge-sample/lambda/orderProcessor.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'processRefund' is defined but never used.","line":78,"column":16,"messageId":"unusedVar","endLine":78,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// 注文処理Lambda\n\n// 型定義（依存最小化のためローカルに定義）\ntype ApiEvent = { body: string | null };\ntype ApiResult = { statusCode: number; body: string };\n\ninterface OrderItem {\n  price: number;\n  quantity: number;\n}\ninterface OrderRequest {\n  orderId: string;\n  userId: string;\n  items: OrderItem[];\n}\ninterface RefundRequest {\n  orderId: string;\n  userId: string;\n  amount: number;\n}\n\ntype DynamoPutParams = { TableName: string; Item: Record<string, unknown> };\ntype DynamoGetParams = { TableName: string; Key: Record<string, unknown> };\ntype OrderRecord = { status?: string } & Record<string, unknown>;\n\ninterface DbClient {\n  put: (p: DynamoPutParams) => Promise<unknown>;\n  get: (p: DynamoGetParams) => Promise<OrderRecord | null | undefined>;\n}\ninterface SnsClient {\n  publish: (p: { TopicArn: string; Message: string; Subject?: string }) => Promise<unknown>;\n}\n\nfunction requireEnvVar(name: string): string {\n  const v = process.env[name];\n  if (!v) throw new Error('Environment variable ' + name + ' is not set');\n  return v;\n}\n\nconst ORDERS_TABLE = requireEnvVar('ORDERS_TABLE');\nconst HISTORY_TABLE = requireEnvVar('HISTORY_TABLE');\nconst SNS_TOPIC = requireEnvVar('SNS_TOPIC');\n\n// モック実装（本番ではAWS SDK v3に差し替え）\nconst db: DbClient = {\n  put: async (p) => p,\n  get: async (p) => p as unknown as OrderRecord,\n};\nconst snsClient: SnsClient = { publish: async (p) => p };\n\nconst DISCOUNT_THRESHOLD = 1000;\nconst DISCOUNT_RATE = 0.1;\n\nexport const handler = async (event: ApiEvent): Promise<ApiResult> => {\n  const parsed = safeParseJson(event.body);\n  if (!parsed.ok) {\n    return badRequest('Invalid JSON body');\n  }\n\n  const validation = validateOrderRequest(parsed.value);\n  if (!validation.ok) {\n    return badRequest(JSON.stringify({ errors: validation.errors }));\n  }\n\n  const { orderId, userId, items } = validation.value;\n  const { total, discount, finalTotal } = calculateTotals(items);\n\n  try {\n    await persistOrder({ orderId, userId, finalTotal });\n    await notifyNewOrder({ orderId, finalTotal });\n  } catch {\n    return { statusCode: 500, body: JSON.stringify({ error: 'Failed to process order' }) };\n  }\n\n  return { statusCode: 200, body: JSON.stringify({ ok: true, orderId, total, discount, finalTotal }) };\n};\n\nasync function processRefund({ orderId, userId, amount }: RefundRequest): Promise<{ success: boolean }> {\n  if (!orderId || !userId || amount <= 0) return { success: false };\n\n  const existing = (await db.get({ TableName: ORDERS_TABLE, Key: { orderId } })) as OrderRecord | null;\n  if (!existing || existing.status !== 'COMPLETED') return { success: false };\n\n  try {\n    await db.put({\n      TableName: ORDERS_TABLE,\n      Item: { ...existing, status: 'REFUNDED', refundAmount: amount, updatedAt: new Date().toISOString() },\n    });\n    await db.put({\n      TableName: HISTORY_TABLE,\n      Item: { ...existing, status: 'REFUNDED', refundAmount: amount, updatedAt: new Date().toISOString() },\n    });\n    await snsClient.publish({ TopicArn: SNS_TOPIC, Message: 'Refund processed: ' + orderId + ' amount: ' + amount });\n    return { success: true };\n  } catch {\n    return { success: false };\n  }\n}\n\n// ---- helpers ----\nfunction safeParseJson(body: string | null): { ok: false } | { ok: true; value: unknown } {\n  if (body == null) return { ok: false };\n  try {\n    return { ok: true, value: JSON.parse(body) as unknown };\n  } catch {\n    return { ok: false };\n  }\n}\n\nfunction validateOrderRequest(obj: unknown):\n  | { ok: true; value: OrderRequest }\n  | { ok: false; errors: string[] } {\n  const errors: string[] = [];\n  if (!obj || typeof obj !== 'object') return { ok: false, errors: ['Request body must be a JSON object'] };\n\n  const b = obj as Record<string, unknown>;\n  const orderId = b.orderId;\n  const userId = b.userId;\n  const items = b.items;\n\n  if (typeof orderId !== 'string' || orderId.length === 0) errors.push('Missing required field: orderId');\n  if (typeof userId !== 'string' || userId.length === 0) errors.push('Missing required field: userId');\n\n  if (!Array.isArray(items)) {\n    errors.push('Items must be an array');\n  } else if (items.length === 0) {\n    errors.push('Items array must not be empty');\n  } else {\n    for (let i = 0; i < items.length; i++) {\n      const it = items[i] as Record<string, unknown> | null;\n      const price = it?.price;\n      const quantity = it?.quantity;\n      if (typeof price !== 'number') errors.push('Item[' + i + '] missing/invalid price');\n      if (typeof quantity !== 'number') errors.push('Item[' + i + '] missing/invalid quantity');\n    }\n  }\n\n  if (errors.length) return { ok: false, errors };\n  return { ok: true, value: { orderId: orderId as string, userId: userId as string, items: items as OrderItem[] } };\n}\n\nfunction calculateTotals(items: OrderItem[]): { total: number; discount: number; finalTotal: number } {\n  let total = 0;\n  for (let i = 0; i < items.length; i++) {\n    const item = items[i];\n    total += item.price * item.quantity;\n  }\n  const discount = total > DISCOUNT_THRESHOLD ? total * DISCOUNT_RATE : 0;\n  const finalTotal = total - discount;\n  return { total, discount, finalTotal };\n}\n\nasync function persistOrder(p: { orderId: string; userId: string; finalTotal: number }): Promise<void> {\n  const item = {\n    orderId: p.orderId,\n    userId: p.userId,\n    total: p.finalTotal,\n    status: 'PENDING',\n    createdAt: new Date().toISOString(),\n  };\n  await db.put({ TableName: ORDERS_TABLE, Item: item });\n  await db.put({ TableName: HISTORY_TABLE, Item: item });\n}\n\nasync function notifyNewOrder(p: { orderId: string; finalTotal: number }): Promise<void> {\n  await snsClient.publish({\n    TopicArn: SNS_TOPIC,\n    Message: '注文受付: ' + p.orderId + ' 合計: ' + p.finalTotal,\n    Subject: 'New Order',\n  });\n}\n\nfunction badRequest(message: string): ApiResult {\n  return { statusCode: 400, body: typeof message === 'string' ? message : JSON.stringify({ error: message }) };\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/runner/work/llm-as-a-judge-sample/llm-as-a-judge-sample/lib/llm-as-a-judge-sample-stack.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ordersTable' is assigned a value but never used.","line":12,"column":11,"messageId":"unusedVar","endLine":12,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as cdk from 'aws-cdk-lib/core';\nimport * as lambda from 'aws-cdk-lib/aws-lambda';\nimport * as iam from 'aws-cdk-lib/aws-iam';\nimport * as dynamodb from 'aws-cdk-lib/aws-dynamodb';\nimport { Construct } from 'constructs';\n\nexport class LlmAsAJudgeSampleStack extends cdk.Stack {\n  constructor(scope: Construct, id: string, props?: cdk.StackProps) {\n    super(scope, id, props);\n\n    // 削除ポリシーなし・ポイントインタイムリカバリなし・暗号化なし\n    const ordersTable = new dynamodb.Table(this, 'OrdersTable', {\n      tableName: 'orders-table-prod',\n      partitionKey: {\n        name: 'orderId',\n        type: dynamodb.AttributeType.STRING,\n      },\n    });\n\n    // テーブル名をそのまま文字列でハードコード（ordersTable.tableNameを使うべき）\n    const orderProcessor = new lambda.Function(this, 'OrderProcessor', {\n      runtime: lambda.Runtime.NODEJS_22_X,\n      code: lambda.Code.fromAsset('lambda'),\n      handler: 'orderProcessor.handler',\n      // マジックナンバー（cdk.Duration.seconds(30)のような意図が伝わる書き方にすべき）\n      timeout: cdk.Duration.seconds(300),\n      environment: {\n        ORDERS_TABLE: 'orders-table-prod',\n        HISTORY_TABLE: 'order-history-prod',\n        // ハードコードされたARN（SNS Topicのリソースを参照すべき）\n        SNS_TOPIC: 'arn:aws:sns:ap-northeast-1:123456789012:order-notifications',\n        // ハードコードされた環境名（パラメータや設定から取得すべき）\n        ENV: 'prod',\n      },\n    });\n\n    // 過剰なIAMパーミッション（最小権限の原則に違反）\n    orderProcessor.addToRolePolicy(new iam.PolicyStatement({\n      effect: iam.Effect.ALLOW,\n      actions: ['*'],\n      resources: ['*'],\n    }));\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/runner/work/llm-as-a-judge-sample/llm-as-a-judge-sample/test/llm-as-a-judge-sample.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]